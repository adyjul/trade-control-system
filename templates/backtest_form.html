{% extends 'base.html' %}
{% block content %}

{% if status == "success" %}
  <div style="padding: 10px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; margin-bottom: 15px;">
    ‚úÖ {{ message or 'Backtest selesai.' }}
  </div>
{% elif status == "error" %}
  <div style="padding: 10px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; margin-bottom: 15px;">
    ‚ùå {{ err }}
  </div>
{% endif %}

<form method="POST">
  <label>Pair:</label><br>
  <input type="text" name="pair" placeholder="contoh: INJUSDT" required><br>

  <label>Timeframe:</label><br>
  <select name="timeframe">
    <option value="15m">15m</option>
    <option value="1h">1h</option>
    <option value="4h" selected>4h</option>
    <option value="1d">1d</option>
  </select><br><br>

  <label>Preset Range:</label><br>
  <select id="preset" name="preset">
    <option value="custom" selected>Custom (pilih tanggal)</option>
    <option value="6m">6 bulan terakhir</option>
    <option value="1y">1 tahun terakhir</option>
    <option value="2y">2 tahun terakhir</option>
  </select><br><br>

  <div id="custom-dates">
    <label>Tanggal Mulai:</label><br>
    <input type="date" id="start_date" name="start_date"><br>

    <label>Tanggal Selesai:</label><br>
    <input type="date" id="end_date" name="end_date"><br><br>
  </div>

  <button type="submit">üîÅ Jalankan Backtest (by Date Range)</button>
</form>

<script>
  // Auto-set tanggal hari ini (end) dan 1 tahun lalu (start) sebagai default saat Custom
  (function initDates() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const endStr = `${yyyy}-${mm}-${dd}`;

    const start = new Date();
    start.setFullYear(start.getFullYear() - 1);
    const sy = start.getFullYear();
    const sm = String(start.getMonth() + 1).padStart(2, '0');
    const sd = String(start.getDate()).padStart(2, '0');

    document.getElementById('end_date').value = endStr;
    document.getElementById('start_date').value = `${sy}-${sm}-${sd}`;
  })();

  const preset = document.getElementById('preset');
  const customWrap = document.getElementById('custom-dates');
  const startInput = document.getElementById('start_date');
  const endInput = document.getElementById('end_date');

  preset.addEventListener('change', function() {
    const now = new Date();
    const endStr = now.toISOString().slice(0,10);

    let start = new Date();
    if (this.value === '6m') {
      start.setMonth(start.getMonth() - 6);
    } else if (this.value === '1y') {
      start.setFullYear(start.getFullYear() - 1);
    } else if (this.value === '2y') {
      start.setFullYear(start.getFullYear() - 2);
    }

    if (this.value === 'custom') {
      customWrap.style.display = 'block';
      startInput.removeAttribute('disabled');
      endInput.removeAttribute('disabled');
    } else {
      customWrap.style.display = 'block'; // tetap tampil supaya user lihat range yg terisi otomatis
      startInput.value = start.toISOString().slice(0,10);
      endInput.value = endStr;
      startInput.setAttribute('disabled', 'disabled');
      endInput.setAttribute('disabled', 'disabled');
    }
  });
</script>

{% endblock %}